<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¥­æ­ªæ­ª - to do</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="header-left">
            <img src="images/image1.jpg" alt="å¤´åƒ" class="header-avatar">
            <h1>é¥­æ­ªæ­ª</h1>
            <span class="house-icon">ğŸ </span>
        </div>
        <nav class="header-nav">
            <a href="index.html" class="nav-item">é¦–é¡µ</a>
            <a href="log.html" class="nav-item">æ—¥å¿—</a>
            <a href="todo.html" class="nav-item active">to do</a>
            <a href="growth.html" class="nav-item">æˆé•¿</a>
            <a href="thought.html" class="nav-item">æ€è€ƒ</a>
        </nav>
    </header>

    <main class="todo-main">
        <div class="calendar-container" id="calendar">
            <!-- æ—¥å†å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="todo-detail" id="todo-detail" style="display: none;">
            <div class="todo-list-container">
                <div class="todo-header-section">
                    <h3 id="selected-date-title"></h3>
                    <p class="todo-date-subtitle" id="todo-date-subtitle"></p>
                    <div class="todo-lock-section" id="todo-lock-section" style="display: none;">
                        <button id="unlock-todo-btn" class="unlock-todo-btn">ğŸ”“ è§£é”ç¼–è¾‘</button>
                    </div>
                </div>
                <ul class="todo-list" id="todo-list">
                    <!-- ä»»åŠ¡åˆ—è¡¨ -->
                </ul>
                <div class="todo-input-section" id="todo-input-section" style="display: none;">
                    <input type="text" id="new-todo" placeholder="æ·»åŠ æ–°ä»»åŠ¡..." autocomplete="off">
                    <button id="add-todo-btn" class="add-btn">â•</button>
                </div>
            </div>
        </div>
        
        <!-- å¯†ç è¾“å…¥æ¨¡æ€æ¡† -->
        <div class="todo-password-modal" id="todo-password-modal" style="display: none;">
            <div class="todo-password-container">
                <div class="lock-icon">ğŸ”’</div>
                <h3>è¯·è¾“å…¥å¯†ç ä»¥ç¼–è¾‘ä»»åŠ¡</h3>
                <input type="password" id="todo-password-input" placeholder="è¾“å…¥å¯†ç " autocomplete="off">
                <div class="password-buttons">
                    <button id="todo-password-confirm">ç¡®è®¤</button>
                    <button id="todo-password-cancel">å–æ¶ˆ</button>
                </div>
                <p class="error-message" id="todo-error-message" style="display: none;">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</p>
            </div>
        </div>
    </main>

    <script src="js/main.js"></script>
    <script>
        const TODO_PASSWORD = '0714'; // ç¼–è¾‘å¯†ç 
        let currentSelectedDate = null;
        let isTodoUnlocked = false;
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»è§£é”ï¼ˆä½¿ç”¨ sessionStorageï¼‰
        if (sessionStorage.getItem('todo-unlocked') === 'true') {
            isTodoUnlocked = true;
        }
        
        // ç”Ÿæˆæ—¥å†ï¼ˆä»å½“å‘¨å‘¨ä¸€å¼€å§‹ï¼Œæ˜¾ç¤º5è¡Œx7åˆ—ï¼‰
        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            
            // åˆ›å»ºè¡¨å¤´
            const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
            const header = document.createElement('div');
            header.className = 'calendar-header';
            weekdays.forEach(day => {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day-header';
                dayCell.textContent = day;
                header.appendChild(dayCell);
            });
            calendar.appendChild(header);
            
            // åˆ›å»ºæ—¥æœŸç½‘æ ¼
            const grid = document.createElement('div');
            grid.className = 'calendar-grid';
            
            // è·å–ä»Šå¤©çš„æ—¥æœŸ
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayDateStr = formatDateForStorage(today);
            
            // è®¡ç®—å½“å‘¨å‘¨ä¸€çš„æ—¥æœŸ
            const currentDay = today.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
            const daysToMonday = currentDay === 0 ? 6 : currentDay - 1; // å¦‚æœæ˜¯å‘¨æ—¥ï¼Œéœ€è¦å¾€å‰6å¤©ï¼›å¦åˆ™å¾€å‰(currentDay-1)å¤©
            const mondayDate = new Date(today);
            mondayDate.setDate(today.getDate() - daysToMonday);
            
            // ä»å½“å‘¨å‘¨ä¸€å¼€å§‹ï¼Œç”Ÿæˆ35ä¸ªæ—¥æœŸï¼ˆ5è¡Œ x 7åˆ—ï¼‰
            const startDate = new Date(mondayDate);
            const currentDate = new Date(startDate);
            
            for (let i = 0; i < 35; i++) {
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const date = String(currentDate.getDate()).padStart(2, '0');
                const dateStr = `${month}.${date}`;
                const dateKey = formatDateForStorage(currentDate);
                
                const cell = document.createElement('div');
                cell.className = 'calendar-cell';
                
                // å¦‚æœæ˜¯ä»Šå¤©ï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
                if (dateKey === todayDateStr) {
                    cell.classList.add('today');
                    cell.innerHTML = `<span class="today-badge">ä»Šå¤©</span><span class="date-number">${dateStr}</span>`;
                } else {
                    cell.textContent = dateStr;
                }
                
                cell.setAttribute('data-date', dateKey);
                cell.setAttribute('data-display', dateStr);
                
                cell.addEventListener('click', function() {
                    // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.calendar-cell').forEach(c => {
                        c.classList.remove('selected');
                    });
                    // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
                    this.classList.add('selected');
                    
                    const dateKey = this.getAttribute('data-date');
                    const displayDate = this.getAttribute('data-display');
                    showTodoDetail(dateKey, displayDate);
                });
                
                grid.appendChild(cell);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            calendar.appendChild(grid);
        }
        
        function formatDateForStorage(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function showTodoDetail(dateStr, displayDate) {
            currentSelectedDate = dateStr;
            
            // è§£ææ—¥æœŸæ˜¾ç¤ºæ˜ŸæœŸå‡ 
            const date = new Date(dateStr);
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const weekday = weekdays[date.getDay()];
            
            document.getElementById('selected-date-title').textContent = displayDate;
            document.getElementById('todo-date-subtitle').textContent = weekday;
            
            // ä» localStorage åŠ è½½ä»»åŠ¡
            const todos = JSON.parse(localStorage.getItem(`todos-${dateStr}`) || '[]');
            
            // æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨
            document.getElementById('todo-detail').style.display = 'block';
            renderTodoList(todos);
            
            // æ ¹æ®è§£é”çŠ¶æ€æ˜¾ç¤º/éšè—ç¼–è¾‘åŠŸèƒ½
            updateEditMode();
        }
        
        function updateEditMode() {
            const lockSection = document.getElementById('todo-lock-section');
            const inputSection = document.getElementById('todo-input-section');
            
            if (isTodoUnlocked) {
                // å·²è§£é”ï¼šæ˜¾ç¤ºè¾“å…¥æ¡†ï¼Œéšè—è§£é”æŒ‰é’®
                lockSection.style.display = 'none';
                inputSection.style.display = 'flex';
            } else {
                // æœªè§£é”ï¼šæ˜¾ç¤ºè§£é”æŒ‰é’®ï¼Œéšè—è¾“å…¥æ¡†
                lockSection.style.display = 'block';
                inputSection.style.display = 'none';
            }
        }
        
        function renderTodoList(todos) {
            const todoList = document.getElementById('todo-list');
            todoList.innerHTML = '';
            
            if (todos.length === 0) {
                // å¦‚æœæ²¡æœ‰ä»»åŠ¡ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€æç¤º
                const emptyState = document.createElement('div');
                emptyState.className = 'todo-empty-state';
                if (isTodoUnlocked) {
                    emptyState.innerHTML = `
                        <div class="empty-icon">ğŸ“</div>
                        <p>è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œæ·»åŠ ä¸€ä¸ªå§ï½</p>
                    `;
                } else {
                    emptyState.innerHTML = `
                        <div class="empty-icon">ğŸ“</div>
                        <p>è¿˜æ²¡æœ‰ä»»åŠ¡</p>
                        <p style="font-size: 14px; color: #999; margin-top: 8px;">è§£é”åå¯æ·»åŠ ä»»åŠ¡</p>
                    `;
                }
                todoList.appendChild(emptyState);
            } else {
                todos.forEach((todo, index) => {
                    const li = document.createElement('li');
                    li.className = todo.completed ? 'completed' : '';
                    
                    // ä½¿ç”¨å›¾æ ‡æ˜¾ç¤ºä»»åŠ¡çŠ¶æ€
                    const statusIcon = todo.completed ? 'âœ…' : 'â­•';
                    const statusClass = todo.completed ? 'todo-completed' : 'todo-pending';
                    
                    // å¦‚æœæœªè§£é”ï¼Œå›¾æ ‡å’Œåˆ é™¤æŒ‰é’®ä¸å¯ç‚¹å‡»
                    const clickable = isTodoUnlocked ? `onclick="toggleTodo(${index})"` : '';
                    const deleteBtn = isTodoUnlocked 
                        ? `<button class="delete-btn" onclick="deleteTodo(${index})" title="åˆ é™¤ä»»åŠ¡">ğŸ—‘ï¸</button>`
                        : '';
                    
                    li.innerHTML = `
                        <span class="todo-status-icon ${statusClass} ${!isTodoUnlocked ? 'readonly' : ''}" ${clickable}>${statusIcon}</span>
                        <span class="todo-text">${todo.text}</span>
                        ${deleteBtn}
                    `;
                    todoList.appendChild(li);
                });
            }
        }
        
        function toggleTodo(index) {
            if (!currentSelectedDate || !isTodoUnlocked) return;
            const todos = JSON.parse(localStorage.getItem(`todos-${currentSelectedDate}`) || '[]');
            if (todos[index]) {
                todos[index].completed = !todos[index].completed;
                localStorage.setItem(`todos-${currentSelectedDate}`, JSON.stringify(todos));
                renderTodoList(todos);
            }
        }
        
        function deleteTodo(index) {
            if (!currentSelectedDate || !isTodoUnlocked) return;
            const todos = JSON.parse(localStorage.getItem(`todos-${currentSelectedDate}`) || '[]');
            todos.splice(index, 1);
            localStorage.setItem(`todos-${currentSelectedDate}`, JSON.stringify(todos));
            renderTodoList(todos);
        }
        
        // è§£é”æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('unlock-todo-btn').addEventListener('click', function() {
            document.getElementById('todo-password-modal').style.display = 'flex';
            document.getElementById('todo-password-input').focus();
        });
        
        // å¯†ç è¾“å…¥æ¡†å›è½¦ç¡®è®¤
        document.getElementById('todo-password-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('todo-password-confirm').click();
            }
        });
        
        // ç¡®è®¤æŒ‰é’®
        document.getElementById('todo-password-confirm').addEventListener('click', function() {
            const password = document.getElementById('todo-password-input').value;
            const errorMsg = document.getElementById('todo-error-message');
            
            if (password === TODO_PASSWORD) {
                isTodoUnlocked = true;
                sessionStorage.setItem('todo-unlocked', 'true');
                document.getElementById('todo-password-modal').style.display = 'none';
                document.getElementById('todo-password-input').value = '';
                errorMsg.style.display = 'none';
                updateEditMode();
                // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ä»¥æ˜¾ç¤ºç¼–è¾‘åŠŸèƒ½
                if (currentSelectedDate) {
                    const todos = JSON.parse(localStorage.getItem(`todos-${currentSelectedDate}`) || '[]');
                    renderTodoList(todos);
                }
            } else {
                errorMsg.style.display = 'block';
                document.getElementById('todo-password-input').value = '';
                document.getElementById('todo-password-input').focus();
            }
        });
        
        // å–æ¶ˆæŒ‰é’®
        document.getElementById('todo-password-cancel').addEventListener('click', function() {
            document.getElementById('todo-password-modal').style.display = 'none';
            document.getElementById('todo-password-input').value = '';
            document.getElementById('todo-error-message').style.display = 'none';
        });
        
        // æ·»åŠ ä»»åŠ¡
        document.getElementById('add-todo-btn').addEventListener('click', function() {
            if (!currentSelectedDate || !isTodoUnlocked) {
                return;
            }
            
            const input = document.getElementById('new-todo');
            const text = input.value.trim();
            if (text) {
                const todos = JSON.parse(localStorage.getItem(`todos-${currentSelectedDate}`) || '[]');
                todos.push({ text: text, completed: false });
                localStorage.setItem(`todos-${currentSelectedDate}`, JSON.stringify(todos));
                renderTodoList(todos);
                input.value = '';
            }
        });
        
        // å›è½¦æ·»åŠ ä»»åŠ¡
        document.getElementById('new-todo').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && isTodoUnlocked) {
                document.getElementById('add-todo-btn').click();
            }
        });
        
        // åˆå§‹åŒ–ç¼–è¾‘æ¨¡å¼
        updateEditMode();
        
        generateCalendar();
    </script>
</body>
</html>

