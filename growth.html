<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>饭歪歪 - 成长</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="header-left">
            <img src="images/image1.jpg" alt="头像" class="header-avatar">
            <h1>饭歪歪</h1>
            <span class="house-icon">🏠</span>
        </div>
        <nav class="header-nav">
            <a href="index.html" class="nav-item">首页</a>
            <a href="log.html" class="nav-item">日志</a>
            <a href="todo.html" class="nav-item">to do</a>
            <a href="growth.html" class="nav-item active">成长</a>
            <a href="thought.html" class="nav-item">思考</a>
        </nav>
    </header>

    <main class="growth-main">
        <aside class="growth-sidebar">
            <div class="category-list" id="category-list">
                <!-- 分类列表将通过 JavaScript 动态生成 -->
            </div>
        </aside>
        <div class="growth-content">
            <!-- 密码锁界面 -->
            <div class="lock-screen" id="lock-screen">
                <div class="lock-container">
                    <div class="lock-icon">🔒</div>
                    <h3>请输入密码</h3>
                    <input type="password" id="password-input" placeholder="输入密码" autocomplete="off">
                    <button id="unlock-btn">解锁</button>
                    <p class="error-message" id="error-message" style="display: none;">密码错误，请重试</p>
                </div>
            </div>
            <!-- 欢迎信息 -->
            <div class="welcome-message" id="welcome-message" style="display: none;">
                <div class="welcome-content">
                    <div class="welcome-emoji">🌟✨</div>
                    <h2>非常欢迎你了解我的成长历程！</h2>
                    <div class="welcome-emoji">💫🎉</div>
                </div>
            </div>
            <!-- Markdown 内容区域 -->
            <div class="markdown-container" id="markdown-content" style="display: none;">
            </div>
        </div>
    </main>

    <script src="js/marked.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        const PASSWORD = '0714'; // 静态密码
        let isUnlocked = false;
        
        // 文件前缀到一级标题的映射关系
        const categoryMapping = {
            'birthday-': '生日',
            'primary-': '小学',
            'middle-': '初中',
            'high-': '高中',
            'university-': '大学',
            'work': '工作'
        };
        
        // 一级标题的顺序
        const categoryOrder = ['生日', '小学', '初中', '高中', '大学', '工作'];
        
        // 动态生成分类列表
        async function generateCategoryList() {
            const categoryList = document.getElementById('category-list');
            const filesByCategory = {};
            
            // 初始化分类
            categoryOrder.forEach(category => {
                filesByCategory[category] = [];
            });
            
            // 检测文件并获取标题
            async function checkAndGetFileInfo(filename) {
                const path = `markdown/growth/${filename}`;
                try {
                    const response = await fetch(path);
                    if (response.ok) {
                        const text = await response.text();
                        // 提取第一行作为标题（去除 # 和空格）
                        const firstLine = text.split('\n')[0].trim();
                        let title = firstLine.startsWith('#') 
                            ? firstLine.substring(1).trim() 
                            : firstLine;
                        // 如果标题为空，使用文件名（去除扩展名）
                        if (!title || title.length === 0) {
                            title = filename.replace('.md', '');
                        }
                        return { filename, title, path };
                    }
                } catch (error) {
                    // 文件不存在或加载失败
                }
                return null;
            }
            
            // 检测所有可能的文件
            const allPossibleFiles = [
                // 生日
                'birthday-family.md', 'birthday-sick.md', 'birthday-play.md',
                // 小学
                'primary-xinghua.md', 'primary-qianxian.md', 'primary-shaanshida.md',
                // 初中
                'middle-xigongda.md',
                // 高中
                'high-xigongda.md',
                // 大学
                'university-zhejiang.md',
                // 工作
                'work.md'
            ];
            
            // 并行检测所有文件
            const checkPromises = allPossibleFiles.map(filename => checkAndGetFileInfo(filename));
            const results = await Promise.all(checkPromises);
            
            // 按分类组织文件
            results.forEach(result => {
                if (result) {
                    const filename = result.filename;
                    // 根据文件名前缀确定分类
                    for (const [prefix, category] of Object.entries(categoryMapping)) {
                        if (filename.startsWith(prefix)) {
                            filesByCategory[category].push(result);
                            break;
                        }
                    }
                }
            });
            
            // 生成分类列表HTML
            categoryOrder.forEach(category => {
                const files = filesByCategory[category];
                if (files.length === 0) return; // 如果该分类下没有文件，跳过
                
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'category-title';
                categoryTitle.textContent = category;
                categoryItem.appendChild(categoryTitle);
                
                const subcategory = document.createElement('div');
                subcategory.className = 'subcategory';
                
                files.forEach(({ filename, title, path }) => {
                    const subcategoryItem = document.createElement('div');
                    subcategoryItem.className = 'subcategory-item';
                    subcategoryItem.textContent = title;
                    subcategoryItem.setAttribute('data-file', filename);
                    subcategory.appendChild(subcategoryItem);
                });
                
                categoryItem.appendChild(subcategory);
                categoryList.appendChild(categoryItem);
            });
            
            // 添加省略号
            const ellipsisItem = document.createElement('div');
            ellipsisItem.className = 'category-item';
            const ellipsisTitle = document.createElement('div');
            ellipsisTitle.className = 'category-title';
            ellipsisTitle.textContent = '......';
            ellipsisItem.appendChild(ellipsisTitle);
            categoryList.appendChild(ellipsisItem);
        }
        
        // 页面加载时生成分类列表，然后设置菜单项状态
        generateCategoryList().then(() => {
            // 检查是否已经解锁（使用 sessionStorage）
            if (sessionStorage.getItem('growth-unlocked') === 'true') {
                isUnlocked = true;
                // 如果已解锁，直接显示 markdown 内容区域，不显示欢迎信息
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('welcome-message').style.display = 'none';
                document.getElementById('markdown-content').style.display = 'block';
                // 移除模糊效果
                document.querySelectorAll('.subcategory-item').forEach(item => {
                    item.classList.remove('blurred');
                    item.style.opacity = '1';
                    item.style.cursor = 'pointer';
                });
                enableMenuItems();
            } else {
                // 如果未解锁，禁用菜单项并添加模糊效果
                document.querySelectorAll('.subcategory-item').forEach(item => {
                    item.classList.add('blurred');
                    item.style.cursor = 'not-allowed';
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        alert('请先解锁页面');
                    });
                });
            }
        });
        
        // 密码输入框实时检测密码（仅用于隐藏错误信息）
        const passwordInput = document.getElementById('password-input');
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            const errorMsg = document.getElementById('error-message');
            
            // 如果正在输入，隐藏错误信息
            if (password.length > 0 && password.length < PASSWORD.length) {
                errorMsg.style.display = 'none';
            }
        });
        
        // 密码输入框回车解锁
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const password = this.value;
                if (password === PASSWORD) {
                    isUnlocked = true;
                    sessionStorage.setItem('growth-unlocked', 'true');
                    unlockPage();
                } else {
                    // 显示错误信息
                    const errorMsg = document.getElementById('error-message');
                    errorMsg.style.display = 'block';
                    this.value = '';
                    this.focus();
                }
            }
        });
        
        // 解锁按钮点击事件
        document.getElementById('unlock-btn').addEventListener('click', function() {
            const password = passwordInput.value;
            if (password === PASSWORD) {
                isUnlocked = true;
                sessionStorage.setItem('growth-unlocked', 'true');
                unlockPage();
            } else {
                // 显示错误信息
                const errorMsg = document.getElementById('error-message');
                errorMsg.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
            }
        });
        
        function unlockPage() {
            // 隐藏锁屏界面
            document.getElementById('lock-screen').style.display = 'none';
            // 显示欢迎信息
            const welcomeMessage = document.getElementById('welcome-message');
            welcomeMessage.style.display = 'flex';
            // 添加淡入动画
            setTimeout(() => {
                welcomeMessage.classList.add('show');
            }, 10);
            
            // 移除模糊效果和旧的事件监听器
            document.querySelectorAll('.subcategory-item').forEach(item => {
                item.classList.remove('blurred');
                item.style.opacity = '1';
                item.style.cursor = 'pointer';
                // 移除所有事件监听器：通过克隆节点来移除
                const newItem = item.cloneNode(true);
                item.parentNode.replaceChild(newItem, item);
            });
            // 启用左侧菜单
            enableMenuItems();
        }
        
        // 点击菜单项时隐藏欢迎信息，显示 markdown 内容
        function showMarkdown() {
            const welcomeMessage = document.getElementById('welcome-message');
            const markdownContent = document.getElementById('markdown-content');
            
            welcomeMessage.classList.remove('show');
            setTimeout(() => {
                welcomeMessage.style.display = 'none';
                markdownContent.style.display = 'block';
            }, 300);
        }
        
        function enableMenuItems() {
            document.querySelectorAll('.subcategory-item').forEach(item => {
                // 移除所有可能存在的旧事件监听器
                item.onclick = null;
                
                item.addEventListener('click', function(e) {
                    if (!isUnlocked) {
                        e.preventDefault();
                        return;
                    }
                    
                    // 移除之前的激活状态
                    document.querySelectorAll('.subcategory-item').forEach(i => {
                        i.classList.remove('active');
                    });
                    
                    // 添加当前激活状态
                    this.classList.add('active');
                    
                    // 隐藏欢迎信息，显示 markdown 内容
                    showMarkdown();
                    
                    // 加载 Markdown 文件
                    const file = this.getAttribute('data-file');
                    loadMarkdown('markdown/growth/' + file);
                });
            });
        }
        
        
        function loadMarkdown(path) {
            fetch(path)
                .then(response => {
                    if (!response.ok) throw new Error('文件不存在');
                    return response.text();
                })
                .then(text => {
                    document.getElementById('markdown-content').innerHTML = marked.parse(text);
                })
                .catch(error => {
                    document.getElementById('markdown-content').innerHTML = '<p>markdown 文件</p>';
                });
        }
    </script>
</body>
</html>

